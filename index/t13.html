<!DOCTYPE html>
<head>
<meta http-equiv="content-type" content="text/html; charset=windows-1251" />
<link rel="stylesheet" type="text/css" media="all" href="content/styles.css" />
<title>EXE и COM форматы.</title>
<link rel="shortcut icon" href="content/icon.ico" type="image/x-icon" />
</head>

<body class="body">
 <a name="up"></a>
 
 
 <!--шапка-->
 <div id="header">
    <div id="header-content">
		<p class="bonch"> Санкт-Петербургский государственный университет телекоммуникаций им. проф. М.А.Бонч-Бруевича<br>
	    <nobr style="color:#ff8000;">Программирование на Машинно-Ориентированных Языках</nobr>
	    </p>
		<a class="home" href="../index.html"><img title="На главную" src="content/home.png" ></a>
    <div id="main_menu">  
<!-- Главное Меню -->	  
<ul class="menu_mainmenu">
<li><a href="themes_3.html" >Теория (часть 1)</a>
<ul>
<li><a href="t1.html" >&diams;Регистры</a>
	<ul>
		<li><a href="t1.html#ron" >&diams;Регистры Общего Назначения</a></li>
		<li><a href="t1.html#ir" >&diams;Индексные Регистры</a></li>
		<li><a href="t1.html#rs" >&diams;Регистры Сегментов</a></li>
		<li><a href="t1.html#ru" >&diams;Регистры - Указатели</a></li>
		<li><a href="t1.html#ruk" >&diams;Регистр Указателя Команд</a></li>
		<li><a href="t1.html#rf" >&diams;Регистр Флагов</a></li>
	</ul>
</li>
<li><a href="t2.html">&diams;Сегменты, принцип сегментации</a></li>
<li><a href="t3.html">&diams;Стек</a></li>
<li><a href="t4.html" >&diams;Адресация</a>
	<ul>
		<li><a href="t4.html#ad" >&diams;Адресация данных</a></li>
		<li><a href="t4.html#ar" >&diams;Режимы адресации</a></li>
	</ul>
</li>
<li><a href="t5.html" >&diams;Организация программы</a>
	<ul>
		<li><a href="t5.html#ops" >&diams;Организация программы.Сегменты</a></li>
		<li><a href="t5.html#mp" >&diams;Модели памяти и упрощенные директивы определения сегментов</a></li>
		<li><a href="t5.html#dz" >&diams;Директивы задания набора допустимых команд</a></li>
	</ul>
</li>		
<li><a href="t6.html">&diams;Структура программы на языке Ассемблера</a>
	<ul>
		<li><a href="t6.html#st" >&diams;Структура программы на языке Ассемблера</a></li>
		<li><a href="t6.html#com" >&diams;Программа типа СОМ</a></li>
	</ul>
</li>
<li><a href="t7.html" >&diams;Инициализация и описание данных</a></li>
<li><a href="t8.html" >&diams;Арифметические команды</a>
	<ul style="top:-235px">
		<li><a href="t8.html#ks" >&diams;Команды сложения ADD, ADC, INC</a>
			<ul>
			<li><a href="t8.html#add" >&diams;ADD</a></li>
			<li><a href="t8.html#adc" >&diams;ADC</a></li>
			<li><a href="t8.html#inc" >&diams;INC</a></li>
			</ul></li>
		<li><a href="t8.html#kv" >&diams;Команды вычитания SUB, SBB, DEC и NEG</a>
		<ul>
			<li><a href="t8.html#kv" >&diams;SUB, SBB, DEC</a></li>
			<li><a href="t8.html#neg" >&diams;NEG</a></li>
		</ul></li>
		<li><a href="t8.html#ku" >&diams;Команды умножения MUL и IMUL</a>
		<ul>
			<li><a href="t8.html#mul" >&diams;MUL</a></li>
			<li><a href="t8.html#imul" >&diams;IMUL</a></li>
		</ul></li>
		<li><a href="t8.html#ubc" >&diams;Умножение больших чисел</a></li>
		<li><a href="t8.html#kd" >&diams;Команды деления DIV и IDIV</a></li>
		<li><a href="t8.html#pr" >&diams;Преобразование байта в слово и слова
		в двойное слово</a></li>
		<li><a href="t8.html#dbc" >&diams;Деление больших чисел</a></li>	
	</ul>
</li>
<li><a href="t9.html" >&diams;Команды передачи управления</a>
	<ul style="top:-215px">
		<li><a href="t9.html#jmp" >&diams;Команда безусловного перехода JMP</a></li>
		<li><a href="t9.html#usl" >&diams;Команды условной передачи управления</a></li>
		<li><a href="t9.html#znak" >&diams;Знаковые и беззнаковые данные</a></li>
		<li><a href="t9.html#bzd" >&diams;Переходы для беззнаковых данных</a></li>
		<li><a href="t9.html#zd" >&diams;Переходы для знаковых данных</a></li>
		<li><a href="t9.html#sp" >&diams;Специальные арифметические проверки</a></li>
	</ul>
</li>
<li><a href="t80.html" >&diams;Команды сдвигов</a></li>	
</ul>

 
<li><a href="themes_3.html" >Теория (часть 2)</a>
<ul>
<li><a href="t81.html">&diams;Команды логических операций</a></li>
<li><a href="t90.html">&diams;Команды циклов</a></li>
<li><a href="t91.html">&diams;Работа с подпрограммами</a></li>
<li><a href="t10.html" >&diams;Операции ввода с клавиатуры и вывода на экран в DOS приложениях</a>
	<ul>
		<li><a href="t10.html#output" >&diams;Вывод на экран средствами DOS</a></li>
		<li><a href="t10.html#input" >&diams;Ввод данных с клавиатуры</a></li>
		<li><a href="t10.html#str-name" >&diams;Ввод и вывод имен (строк)</a>
		<ul style="top:-82px"><li><a href="t10.html#str-out" >&diams;Вывод текста запроса</a></li>
			<li><a href="t10.html#str-in" >&diams;Ввод имени с клавиатуры</a></li>
			<li><a href="t10.html#str-zv" >&diams;Установка звукового сигнала и ограничителя '$'</a></li>
			<li><a href="t10.html#str-centr" >&diams;Центрирование и вывод имени на экран</a></li>
			<li><a href="t10.html#clear" >&diams;Очистить экран</a></li>
			<li><a href="t10.html#str" >&diams;Установка курсора (строка/столбец)</a></li>
		</ul></li>
		<li><a href="t10.html#pr" >&diams;Преобразование строки в число и числа в строку</a>
		<ul><li><a href="t10.html#asc" >&diams;Преобразование ASCII-формата в двоичный формат</a></li>
		    <li><a href="t10.html#toAsc" >&diams;Преобразование двоичного формата в ASCII-формат</a></li>
		</ul></li>	</ul>
</li>
<li><a href="t10-2.html" >&diams;Программирование в UNIX</a>
	<ul style="top:-50px">
		<li><a href="t10-2.html#pr_unix" >&diams;Программирование в LINUX (первый пример)</a></li>
		<li><a href="t10-2.html#make" >&diams;Утилита make</a></li>
		<li><a href="t10-2.html#perem" >&diams;Переменные</a></li>
		<li><a href="t10-2.html#output" >&diams;Вывод на экран через INT 80H</a></li>
		<li><a href="t10-2.html#printf" >&diams;Вывод с помощью printf</a></li>
		<li><a href="t10-2.html#vizov" >&diams;Вызов функций scanf и printf из Nasm</a></li>
		<li><a href="t10-2.html#arifm" >&diams;Арифметические операции  в формате ASCII</a>
		<ul style="top:-137px">
		<li><a href="t10-2.html#sloz" >&diams;Сложение в ASCII-формате</a></li>
		<li><a href="t10-2.html#vic" >&diams;Вычитание в ASCII-формате</a></li>
		<li><a href="t10-2.html#umn" >&diams;Умножение в ASCII-формате</a></li>
		<li><a href="t10-2.html#del" >&diams;Деление в ASCII-формате</a></li>
		<li><a href="t10-2.html#bcd" >&diams;Двоично-десятичный формат (SCD)</a></li>
	</ul></li></ul>
</li>	
<li><a href="t13.html">&diams;EXE и COM форматы</a>
	<ul style="top:-171px">
		<li><a href="t13.html#rp" >&diams;Распределение программы в памяти</a></li>
		<li><a href="t13.html#exe+com" >&diams;EXE- и COM-программы</a></li>
		<li><a>&diams;EXE</a>
		<ul><li><a href="t13.html#exe" >&diams;Заголовок EXE-файла</a></li>
		<li><a href="t13.html#exe-str" >&diams;Описание структуры заголовка EXE 
		файла и таблицы расположения сегментов</a></li>
		</ul></li>
		<li><a href="t13.html#pzpp" >&diams;Процесс загрузки программ в память</a></li>
		<li><a href="t13.html#prps" >&diams;Префикс программного сегмента</a></li>
		<li><a href="t13.html#str-psp" >&diams;Структура PSP</a></li>
		<li><a href="t13.html#exe-pr" >&diams;EXE-программы</a></li>
		<li><a href="t13.html#com-pr" >&diams;COM-программы</a></li>
		<li><a href="t13.html#exit-pr" >&diams;Выход из программы</a></li>
	</ul>
</li>
<li><a href="t11.html" >&diams;Обработка массивов</a>
	<ul style="top:-36px">
		<li><a href="t11.html#str" >&diams;Обработка строк</a></li>
		<li><a href="t11.html#m1" >&diams;Обработка одномерных массивов</a></li>
		<li><a href="t11.html#m2" >&diams;Двумерные массивы</a></li>
		</ul>
</li>	
<li><a href="t12.html" >&diams;Математический сопроцессор</a>
	<ul style="top:-190px">
		<li><a href="t12.html#ms" >&diams;Математический сопроцессор</a></li>
		<li><a href="t12.html#och" >&diams;Особые числав</a></li>
		<li><a href="t12.html#reg" >&diams;Регистры</a></li>
		<li><a href="t12.html#rd" >&diams;Регистры данных</a></li>
		<li><a href="t12.html#sc" >&diams;Система команд</a></li>
		<li><a href="t12.html#uoc" >&diams;Условные обозначения для команд базового сопроцессора</a></li>
		<li><a>&diams;Команды</a><ul>
			<li><a href="t12.html#cpd" >&diams;Команды пересылки данных</a></li>
			<li><a href="t12.html#czk" >&diams;Команды загрузки констант</a></li>
			<li><a href="t12.html#ak" >&diams;Арифметические команды</a></li>
			<li><a href="t12.html#sak" >&diams;Специальные арифметические команды</a></li>
		</ul></li></ul>
</li>	
<li><a href="t14.html">&diams;Машинные коды</a>
	<ul style="top:-140px">
		<li><a href="t14.html#mk" >&diams;Машинные коды</a></li>
		<li><a href="t14.html#bko" >&diams;Байт кода операции</a></li>
		<li><a href="t14.html#bsa" >&diams;Байт способа адресации</a></li>
		<li><a href="t14.html#ra" >&diams;Режимы адресации</a></li>
		<li><a href="t14.html#pras" >&diams;Примеры ассемблирования</a></li>
	</ul>
</li>		
</ul>


<li><a href="themes_1.html" >Практикум</a>
<ul>
<li><a href="l1.html" > &diams; Лабораторная Работа №1 </a></li>
<li><a href="l2.html" > &diams; Лабораторная Работа №2</a></li>
<li><a href="l3.html" > &diams; Лабораторная Работа №3</a></li>
<li><a href="l4.html" > &diams; Лабораторная Работа №4</a></li>
<li><a href="l5.html" > &diams; Лабораторная Работа №5</a></li>
</ul>  </ul>
<!-- Главное Меню -- END -->
</div>
</div>
</div>
  
  
 <!-- страничка-->
<div id="width-page-00">
    <div id="page-00" style=" overflow:  hidden; height:  100%;">
		<marquee loop="-1" scrollamount="1" behavior="alternate" direction="up" height="100%">
		П р о ч и е<p> </p>с в е д е н и я  
		</marquee>
	</div>
</div>
 
   <div id="width-page">
      <div id="page">
		 <div id="page_content">
            <div class="themes"> 
		
    <a name="rp"></a>
	<h2>Распределение программы в памяти.</h2>
	<p class="stress">	 </p> 
	<p class="text">                  
	Рассмотрим распределение памяти на примере простейшей программы.
	<table>
		<tr>
			<td width="300px"><comment>; Данные программы</comment><br>
			<code>DATA	SEGMENT<br>
			MSG	DB	‘Текст$’
			<br>DATA	ENDS
			<br>STK SEGMENT STACK
			<br>DB 256 dup(?)
			<br>STK ENDS</code>
			<br><comment>; Код программы</comment>
			<br><code>CODE	SEGMENT
			<br>ASSUME CS:CODE,DS:DATA,SS:STK
			<br>START:	
			<br>MOV	AX,DATA
			<br>MOV	DS,AX</code></td>
			<td><comment></comment></td>
		</tr>
		<tr>
			<td><code>MOV	AH,09H</code></td>
			<td><comment>; Вывод сообщения</comment></td>
		</tr>
		<tr>
			<td><code>MOV	DX,OFFSET MSG
			<br>INT	21H</code></td>
			<td><comment></comment></td>
		</tr>
		<tr>
			<td><code>MOV	AH,4CH</code></td>
			<td><comment>; Завершение работы</comment></td>
		</tr>
		<tr>
			<td><code>INT	21H
			<br>CODE ENDS
			<br>END	START</code></td>
			<td><comment></comment></td>
		</tr>
	</table><br>
	<p class="text">
	В этой программе явно описаны <b>три</b> сегмента – <b>кода</b> с именем 
	<code>CODE</code>, <b>данных</b> с именем <code>DATA</code> и <b>стека</b> с 
	именем <code>STK</code>. Директива <code>ASSUME</code> связывает имена этих
	сегментов, которые в общем случае могут быть произвольными, с сегментными регистрами
	<b>CS</b> , <b>DS</b> и <b>SS</b> соответственно. Распределение памяти при 
	загрузке программы на исполнение показано ниже:
	<ul class="text"><li>Распределение в памяти ЕХЕ программы.<br><br>
		<img src="content/img/rasp-exe.PNG" width="600px">
	</li>
	<li>Распределение в памяти СОМ программы.<br></li></ul><br>
		<img src="content/img/rasp-com.PNG" width="760px" style="margin-left:-3.3%">
	</p>
	<p class="text">
	После инициализации в регистре <b>IP</b> находится смещение первой команды программы 
	относительно начала кодового сегмента, адрес которого помещен в регистр <b>CS</b>. 
	Процессор, считывая эту команду, начинает выполнение программы, постоянно изменяя 
	содержимое регистра <b>IP</b> и при необходимости <b>CS</b> для получения кодов 
	очередных команд. <b>DS</b> после загрузки программы установлен на начало <b>PSP</b>,
	поэтому для его использования в первых двух командах программы выполняется загрузка
	<b>DS</b> значением сегмента данных.
	</p>
	
	 <a name="exe+com"></a>
	<h2>EXE- и COM-программы.</h2>
	<p class="stress">	 </p> 
	<p class="text">   
	<b>DOS</b> может загружать и выполнять программные файлы двух типов – <b>COM</b> и <b>EXE</b>.
	<br>Ввиду сегментации адресного пространства процессора <b>8086</b> и того факта, что 
	переходы (<code>JMP</code>) и вызовы (<code>CALL</code>) используют относительную адресацию,
	оба типа программ могут выполняться в любом месте памяти. Программы никогда не пишутся в 
	предположении, что они будут загружаться с определенного адреса (за исключением некоторых спец. программ).
	<br><br>Файл <b>COM</b>-формата – это двоичный образ кода и данных программы. Такой 
	файл может занимать <b>менее 64K</b>.<br><br>
	Файл <b>EXE</b>-формата содержит специальный заголовок, при помощи которого загрузчик 
	выполняет настройку ссылок на сегменты в загруженном модуле.</p>

	 <a name="exe"></a>
	<h2>Заголовок EXE-файла.</h2>
	<p class="stress">	 </p> 
	<p class="text">
	Заголовок <b>EXE</b>-файла состоит из форматированной зоны и таблицы расположения сегментов
	(<b><i>Relocation Table</i></b>).  
	<center><table border="1" cellspacing="0" cellpadding="10" width="95%" class="text">
	<caption> <big><b>Форматированная зона выглядит следующим образом:</b></big></caption>
		<tr>
			<td>(0)2</td>
			<td>signature</td>
			<td>два байта <b>'MZ'</b> (<b>4Dh, 5Ah</b>), индентифицирующие файл в формате <b>EXE</b></td>
		</tr>
		<tr>
			<td>(+2)2</td>
			<td>part_pag</td>
			<td>длина последней страницы программы в байтах (страница содержит <b>512</b> байт)</td>
		</tr>
		<tr>
			<td>(+4)2</td>
			<td>filesize</td>
			<td>размер программы в страницах по <b>512</b> байт</td>
		</tr>
		<tr>
			<td>(+6)2</td>
			<td>relitem</td>
			<td>число элементов в таблице расположения сегментов</td>
		</tr>
		<tr>
			<td>(+8)2</td>
			<td>hdr_size</td>
			<td>размер заголовка файла в параграфах (длина параграфа <b>-16</b> байт)</td>
		</tr>
		<tr>
			<td>(+10)2</td>
			<td>min_mem</td>
			<td>минимальное количество памяти в параграфах, которое нужно зарезервировать
			в памяти за концом загруженной программы</td>
		</tr>
		<tr>
			<td>(+12)2</td>
			<td>max_mem</td>
			<td>максимальное количество памяти в параграфах, которое нужно зарезервировать в
			памяти за концом загруженной программы</td>
		</tr><tr>
			<td>(+14)2</td>
			<td>ss_reg</td>
			<td>величина смещения от начала программы, которая используется для загрузки 
			сегментного регистра стека <b>SS</b></td>
		</tr><tr>
			<td>(+16)2</td>
			<td>sp_reg</td>
			<td>величина смещения от начала программы, которая используется для загрузки
			регистра <b>SP</b></td>
		</tr><tr>
			<td>(+18)2</td>
			<td>chk_summ</td>
			<td>контрольная сумма всех слов в файле</td>
		</tr><tr>
			<td>(+20)2</td>
			<td>ip_rcg</td>
			<td>значение для регистра <b>IP</b>, которое будет использовано при
			начальном запуске программы</td>
		</tr><tr>
			<td>(+22)2</td>
			<td>cs_reg</td>
			<td>смещение от начала программы для установки сегментного регистра кода <b>CS</b></td>
		</tr><tr>
			<td>(+24)2</td>
			<td>relt_off</td>
			<td>смещение от начала файла таблицы расположения сегментов программы</td>
		</tr><tr>
			<td>(+26)2</td>
			<td>overlay</td>
			<td>номер оверлея, равен <b>0</b> для основного модуля</td>
		</tr>
	</table></center></p>
	<p class="text">
	Таблица расположения сегментов программы начинается сразу после форматированной области
	и состоит из четырехбайтовых значений в формате <code>"смещение:сегмент"</code>. <br><br>
	Область файла после таблицы расположения сегментов выравнивается на границу параграфа
	с помощью <b><ins>байта-заполнителя</ins></b>, и дальше начинается сама программа. 
	</p>
		
	<a name="exe-str"></a>
	<h2>Описание структуры заголовка EXE файла и таблицы расположения сегментов.</h2>
	<p class="stress">	 </p> 
	<p class="text">
		<code>typedef struct _EXE_HDR_ {
			<br>unsigned signature;
			<br>unsigned part_pag;
			<br>unsigned file_size;
			<br>unsigned rel_item;
			<br>unsigned hdr_size;
			<br>unsigned min_mem;
			<br>unsigned max_mem;
			<br>unsigned ss_reg;
			<br>unsigned sp_reg;
			<br>unsigned chk_summ;
			<br>unsigned ip_reg;
			<br>unsigned cs_reg;
			<br>unsigned relt_off;
			<br>unsigned overlay;
		<br>} EXE_HDR;
		<br>typedef struct _RELOC_TAB_ {
			<br>unsigned offset;
			<br>unsigned segment;
		<br>} RELOC_TAB</code>
	</p>
		
	<a name="pzpp"></a>
	<h2>Процесс загрузки программ в память.</h2>
	<p class="stress">	 </p> 
	<p class="text">	
	<ins>Загрузка <b>COM-</b> и <b>EXE-программ</b> происходит по-разному, однако есть некоторые
	действия, которые операционная система выполняет в обоих случаях одинаково</ins>.<br><br> 
	Определяется наименьший сегментный адрес свободного участка памяти для загрузки программы 
	(обычно <b>DOS</b> загружает программу в младшие адреса памяти, если при редактировании 
	не указана загрузка в старшие адреса).<br><br> 
	Создаются <b>два</b> блока памяти  - блок памяти <b>для переменных среды</b> и блок памяти 
	<b>для PSP и программы</b>.<br><br> 	
	В блок памяти переменных среды помещается путь файла программы.<br><br> 
	Заполняются поля префикса сегмента программы <b>PSP</b> в соответствии с характеристиками 
	программы (количество памяти, доступное программе, адрес сегмента блока памяти, содержащего
	переменные среды и т.д.)<br><br> 
	Устанавливается адрес области <b>Disk Transfer Area</b> (<b>DTA</b>) на вторую половину 
	<b>PSP</b> (<b>PSP:0080</b>). <br><br>
	Анализируются параметры запуска программы на предмет наличия в первых двух параметрах
	идентификаторов дисковых устройств. По результатам анализа устанавливается содержимое 
	регистра <b>AX</b> при входе в программу. Если первый или второй параметры не содержат
	правильного идентификатора дискового устройства, то соответственно в регистры <b>AL</b>
	и <b>AH</b> записывается значение <b>FF</b>.<br><br> 
	<ins>А дальше действия системы по загрузке программ форматов <b>COM</b> и <b>EXE</b> 
	будут различаться</ins>. <br><br>
	<big><ins>Для COM-программ</ins>:</big><br>
	Для <b>COM</b>-программ, которые представляют собой двоичный образ односегментной 
	программы, выполняется чтение файла программы с диска и запись его в память по 
	адресу <b>PSP:0100</b>. Вообще говоря, программы типа <b>COM</b> могут состоять из 
	нескольких сегментов, но в этом случае они должны сами управлять содержимым сегментных
	регистров, используя в качестве базового адреса адрес <b>PSP</b>.<br><br> 	
	После загрузки файла операционная система для <b>COM</b>-программ выполняет следующие 
	действия: <ul class="text">
	<li>сегментные регистры <b>CS, DS, ES, SS</b> устанавливаются на начало <b>PSP</b>;</li> 
	<li>регистр <b>SP</b> устанавливается на конец сегмента <b>PSP</b>;</li> 
	<li>вся область памяти после <b>PSP</b> распределяется программе;</li> 
	<li>в стек записывается слово <b>0000</b>;</li> 
	<li>указатель команд <b>IP</b> устанавливается на <b>100h</b> (начало программы) с 
	помощью команды <b>JMP</b> по адресу <b>PSP:100</b>.</li></ul></p> 
	<p class="text">
	<big><ins>Для EXE-программ</ins>:</big><br>
	Загрузка <b>EXE</b>-программ происходит значительно сложнее, так как связана с
	настройкой сегментных адресов: <ul class="text">
	<li>Считывается во внутренний буфер <b>DOS</b> форматированная часть заголовка файла.</li> 
	<li>Определяется размер загрузочного модуля по формуле:<br><code> 
		size=((file_size*512)-(hdr_size*16)-part_pag</code></li>
	<li>Определяется смещение начала загрузочного модуля в <b>EXE</b>-файле как 
	<code>hdr_size*16</code>. </li>
	<li>Вычисляется сегментный адрес для загрузки <b>START_SEG</b>, обычно используется 
	значение <b>PSP+100h</b>.</li> 
	<li>Загрузочный модуль считывается в память по адресу <b>START_SEG:0000</b>.</li> 
	<li>Сканируются элементы таблицы перемещений, располагающейся в <b>EXE</b>-файле
	со смещением <b>relt_off</b>.</li> 
	<li>Для каждого элемента таблицы: <ol>
		<li>Считывается содержимое элемента таблицы как два двухбайтных слова (<b>OFF,SEG</b>).</li> 
		<li>Вычисляется сегментный адрес ссылки перемещения <nobr>
		<code>REL_SEG = (START_SEG + SEG)</code></nobr></li>
		<li>Выбирается слово по адресу <b>REL_SEG:OFF</b>, к этому слову прибавляется 
		значение <b>START_SEG</b>, затем сумма записывается обратно по тому же 
		адресу.</li> </ol></li>
	<li>Заказывается память для программы, исходя из значений <b>min_mem</b> и <b>max_mem</b>.</li> 
	<li>Инициализируются регистры, и программа запускается на выполнение.<br> 	
	При инициализации регистры <b>ES</b> и <b>DS</b> устанавливаются на <b>PSP</b>, 
	регистр <b>AX</b> устанавливается так же, как и для <b>COM</b>-программ, в сегментный 
	регистр стека <b>SS</b> записывается значение <b>START_SEG + ss_reg</b>, а в 
	<b>SP</b> записывается <b>sp_reg</b>.</li> 
	<li>Для запуска программы в <b>CS</b> записывается <b>START_SEG+cs_reg</b>, а в <b>IP - ip_reg</b>.
	<br>Такая запись невозможна напрямую, поэтому операционная система сначала записывает
	в свой стек значение для <b>CS</b>, затем значение для <b>IP</b> и после этого выполняет
	команду дальнего возврата <b>RETF</b> (команда возврата из дальней процедуры).</li></ul> 
	</p>
		
	<a name="prps"></a>
	<h2>Префикс программного сегмента .</h2>
	<p class="stress">	 </p> <p>	
	<center><table border="1" cellspacing="0" cellpadding="10" width="95%" class="text">
		<tr>
			<td>(0)2</td>
			<td>int 20h</td>
			<td>двоичный код команды <b>int 20h</b> (программы могут использовать эту
			команду для завершения своей работы)</td>
		</tr>
		<tr>
			<td>(+2)2</td>
			<td>mem_top</td>
			<td>нижняя граница доступной памяти в системе в парафафах</td>
		</tr>
		<tr>
			<td>(+4)1</td>
			<td>reserv1</td>
			<td>зарезервировано</td>
		</tr>
		<tr>
			<td>(+5)5</td>
			<td>call_dsp</td>
			<td>команда вызова <b>FAR CALL</b> диспетчера <b>MS-DOS</b></td>
		</tr>
		<tr>
			<td>(+10)4</td>
			<td>tcrm_adr</td>
			<td>адрес завершения (Terminate Address)</td>
		</tr>
		<tr>
			<td>(+14)4</td>
			<td>cbrk_adr</td>
			<td>адрес обработчика <b>Ctrl-Break</b></td>
		</tr>
		<tr>
			<td>(+18)4</td>
			<td>crit_err</td>
			<td>адрес обработчика критической ошибки</td>
		</tr><tr>
			<td>(+22)2</td>
			<td>pam psp</td>
			<td>сегмент <b>PSP</b> программы, запустившей данную 
			программу (программы-родителя)<b>SS</b></td>
		</tr><tr>
			<td>(+24)20</td>
			<td>file_tab</td>
			<td>таблица открытых файлов, если здесь находятся байты <b>0FFH</b>,
			то таблица не используется</td>
		</tr><tr>
			<td>(+44)2</td>
			<td>env_seg</td>
			<td>сегмент блока памяти, содержащего переменные среды</td>
		</tr><tr>
			<td>(+46)4</td>
			<td>ss_sp</td>
			<td>адрес стека <b>SS:SP</b> программы</td>
		</tr><tr>
			<td>(+50)2</td>
			<td>max_open</td>
			<td>максимальное число открытых файлов </td>
		</tr><tr>
			<td>(+52)4</td>
			<td>file_tba</td>
			<td>адрес таблицы открытых файлов </td>
		</tr><tr>
			<td>(+56)24</td>
			<td>reserv2</td>
			<td>зарезервировано</td>
		</tr><tr>
			<td>(+80)3</td>
			<td>disp</td>
			<td>диспетчер функций <b>DOS</b></td>
		</tr>
		<tr>
			<td>(+83)9</td>
			<td>reserv3</td>
			<td>зарезервировано</td>
		</tr>
		<tr>
			<td>(+92)16</td>
			<td>fcb1</td>
			<td>форматируется как стандартный <b>FCB</b>, если первый аргумент 
			командной строки содержит правильное имя файла</td>
		</tr>
		<tr>
			<td>(+108)20</td>
			<td>fcb2</td>
			<td>заполняется для второго аргумента командной строки аналогично <b>fcb1</b></td>
		</tr>
		<tr>
			<td>(+128)1</td>
			<td>p_size</td>
			<td>число значащих символов в неформатированной области параметров, 
			либо буфер обмена с диском <b>DTA</b>, назначенный по умолчанию</td>
		</tr>
		<tr>
			<td>(+129)127</td>
			<td>parm</td>
			<td>неформатированная область параметров, заполняется при запуске программы 
			из командной строки </td>
		</tr>
	</table></center></p>	
		
	<a name="str-psp"></a>
	<h2>Структура PSP.</h2>
	<p class="stress">	 </p>
	<p class="text">	
	<code>typedef struct _PSP_ {
        <br>unsigned char int20h[2];
       <br> unsigned mem_top;
       <br> unsigned char reserv1;
       <br> unsigned char call_dsp[5];
       <br> void far *term_adr;
      <br>  void far *cbrk_adr;
       <br> void far *crit_err;
       <br> unsigned parn_psp;
      <br>  unsigned char file_tab[20];
      <br>  unsigned env_seg;
      <br>  void far *ss_sp;
      <br>  unsigned max_open;
      <br>  void far *file_tba;
      <br>  unsigned char reserv2[24];
      <br>  unsigned char disp[3];
      <br>  unsigned char reserv3[9];
      <br>  unsigned char fcb1[16];
     <br>   unsigned char fcb2[20];
       <br> unsigned char p_size;
      <br>  unsigned char parm[127];
	<br>} PSP;
	</code>
	<br><br>	
	Программы могут получить из <b>PSP</b> такую информацию, как параметры командной строки при 
	запуске, размер доступной памяти, найти сегмент области переменных среды и т.д.<br><br> 
	Как программе узнать адрес своего <b>PSP</b>?<br> Очень просто сделать это для программ, 
	написанных на языке ассемблера: при запуске программы этот адрес передается ей через 
	регистры <b>DS</b> и <b>ES</b>. То есть этот адрес равен <b>DS:0000</b> или <b>ES:0000</b>
	(для <b>COM</b>-программ на <b>PSP</b> указывают также регистры <b>CS</b> и <b>SS</b>). 
	</p>
		
	<a name="exe-pr"></a>
	<h2>EXE-программы.</h2>
	<p class="stress">	 </p>
	<p class="text">			
	<b>EXE</b>-программы содержат несколько программных сегментов, включая сегмент кода, 
	данных и стека. В процессе загрузки считывается информация заголовка <b>EXE</b> в 
	начале файла и выполняется перемещение адресов сегментов. Это означает, что ссылки типа
	<br><code>mov	ax,data_seg<br>
	mov	ds,ax</code> <br>и<br><code> 
	call	my_far_proc</code><br>
	должны быть приведены (пересчитаны), чтобы учесть тот факт, что программа была загружена 
	в произвольно выбранный сегмент. <br><br>
	После перемещения управление передается загрузочному модулю посредством инструкции далекого
	перехода (<b>FAR JMP</b>) к адресу <b>CS:IP</b>, извлеченному из заголовка <b>EXE</b>.<br><br>
	В момент получения управления программой <b>EXE</b> -формата:<ul class="text">	
		<li><b>DS</b> и <b>ES</b> указывают на начало <b>PSP</b></li>
		<li><b>CS, IP, SS</b> и <b>SP</b> инициализированы значениями, указанными в заголовке
		<b>EXE</b></li>
		<li>поле <b>PSP MemTop</b> (вершина доступной памяти системы в параграфах) содержит 
		значение, указанное в заголовке <b>EXE</b>. Обычно вся доступная память распределена
		программе</li></ul> 
	</p>

	<a name="com-pr"></a>
	<h2>COM-программы.</h2>
	<p class="stress">	 </p>
	<p class="text">	
	<b>COM</b>-программы содержат единственный сегмент . Образ <b>COM</b>-файла считывается с 
	диска и помещается в память, начиная с <b>PSP:0100h</b>. В общем случае, <b>COM</b>-программа
	может использовать множественные сегменты, но тогда она должна сама вычислять сегментные 
	адреса, используя <b>PSP</b> как базу.<br><br>
	<b>COM</b>-программы предпочтительнее <b>EXE</b>-программ, когда дело касается небольших 
	ассемблерных утилит. Они быстрее загружаются, ибо не требуется перемещения сегментов, и 
	занимают меньше места на диске, поскольку заголовок <b>EXE</b> и сегмент стека отсутствуют 
	в загрузочном модуле. <br><br>
	После загрузки двоичного образа <b>COM</b>-программы:<ul class="text">
	<li><b>CS, DS, ES</b> и <b>SS</b> указывают на <b>PSP</b>;</li>
	<li><b>SP</b> указывает на конец сегмента <b>PSP</b> (обычно <b>0FFFEH</b>, но может быть
	и меньше, если полный <b>64K</b> сегмент недоступен);</li> 
	<li>слово по смещению <b>06H</b> в <b>PSP</b> (доступные байты в программном сегменте) 
	указывает, какая часть программного сегмента доступна;</li>
	<li>вся память системы за программным сегментом распределена программе;</li>
	<li>слово <b>00H</b> помещено (<b>PUSH</b>) в стек;</li>
	<li><b>IP</b> содержит <b>100H</b> (первый байт модуля) в результате команды
	<nobr><code>JMP PSP:100H</code></nobr>.</li></ul>
	</p>

	<a name="exit-pr"></a>
	<h2>Выход из программы.</h2>
	<p class="stress">	 </p>
	<p class="text">	
	Завершить программу можно следующими способами:<ul class="text">
	<li>через функцию <b>4CH</b> (<b>EXIT</b>) прерывания <b>21H</b> в любой момент,
	независимо от значений регистров;</li>
	<li>через функцию <b>00H</b> прерывания <b>21H</b> или прерывание <b>INT 20H</b>,
	когда <b>CS</b> указывает на <b>PSP</b>.</li></ul></p>
	<p class="text">Функция <b>DOS 4CH</b> позволяет возвращать родительскому процессу код выхода, 
	который может быть проверен вызывающей программой или командой <b>COMMAND.COM "IF 
	ERRORLEVEL"</b>.<br><br>
	Можно также завершить программу и оставить ее постоянно резидентной (<b>TSR</b>),
	используя либо <b>INT 27H</b> , либо функцию <b>31H</b> (<b>KEEP</b>) прерывания
	<b>21H</b>. <br><br>
	Последний способ имеет те преимущества, что резидентный код может быть длиннее <b>64K</b>,
	и что в этом случае можно сформировать код выхода для родительского процесса.
	</p>
	
 <!-- страничка -- END -->
   </div></div></div>
 
      <div id="basement"><div id="basement-content">
         <div id="basement_text">
            <br>Программирование на Машинно-Ориентированных Языках.<br>
			Преподаватель: Коробов С.А.<br><br>
      </div>
	  <a class="home2" href="../index.html"><img title="На главную" src="content/home.png"></a>
	  <a class="book" href="themes_3.html"><img title="К оглавлению" src="content/book.png"></a>
	  </div>
	  <a class="min1" href="t10-2.html"><img title="Предыдущая тема" src="content/left.png"></a>
	  <a class="max1" href="t11.html"><img title="Следующая тема" src="content/right.png"></a>
	  </div>
</body>
 </html>
